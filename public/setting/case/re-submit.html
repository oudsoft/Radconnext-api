<!DOCTYPE html>
<html>
  <head>
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
    <title>Rad Connext</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  	<script type="text/javascript" src="../../lib/jquery.js"></script>
  	<script type="text/javascript" src="../../lib/jquery-ui.min.js"></script>
  	<script type="text/javascript" src="../../lib/jquery.loading.min.js"></script>
    <script type="text/javascript" src="../../lib/notify.min.js"></script>
    <link rel='stylesheet' href='../../lib/jquery-ui.min.css' />
    <link rel='stylesheet' href='../../stylesheets/style.css' />
  </head>
  <body>
    <div id="ShowCaseList">
      <div>
        <label for="HospitalID">Hospital:</label><span>  </span>
        <select id="HospitalID"></select><span>  </span>
        <label for="Limit">Limit:</label><span>  </span>
        <select id="Limit"></select><span>  </span>
        <input type="button" id="LoadCaseCmd" value="Load Cases."/>
      </div>
      <div id="CaseList"></div>
    </div>
  </body>
</html>
<style>

</style>
<script type="text/javascript">

  $( document ).ready(function() {
    console.log(localStorage.getItem('token'));

    $.ajaxSetup({
      beforeSend: function(xhr) {
        xhr.setRequestHeader('Authorization', localStorage.getItem('token'));
      }
    });
    let userdata = JSON.parse(localStorage.getItem('userdata'));
    console.log(userdata);

    initPage();

    $('#LoadCaseCmd').on('click', (evt)=>{
      doLoadLast20Cases(evt);
    });
  });

  const initPage = function(){
    $('#Limit').empty();
    $('#Limit').append($('<option value="10">10</option>'));
    $('#Limit').append($('<option value="20">20</option>'));
    $('#Limit').append($('<option value="30">30</option>'));
    $('#Limit').append($('<option value="40">40</option>'));
    $('#Limit').append($('<option value="50">50</option>'));
    $('#Limit').append($('<option value="100">100</option>'));
    $('#Limit').val("20").change();
    $('#HospitalID').empty();
    doCallLoadHospitalList().then((hospitals)=>{
      hospitals.Options.forEach((hospital, i) => {
        let hosItem = $('<option value="' + hospital.Value + '">' + hospital.DisplayText + '</option>');
        $(hosItem).appendTo($('#HospitalID'));
      });
    });
  }

  const doCallLoadHospitalList = function(){
    return new Promise(async function(resolve, reject) {
      let callUrl = '/api/hospital/options';
      let params = {};
      $.post(callUrl, params).then((response) => {
        resolve(response);
      });
    });
  }

  const doLoadRadioFullName = function(radioId){
    return new Promise(async function(resolve, reject) {
      let callUrl = '/api/users/select/' + radioId;
      let params = {};
      $.get(callUrl, params).then((response) => {
        resolve(response);
      });
    });
  }

  const doCallLoadLast20Cases = function(hospitalId, limit){
    return new Promise(async function(resolve, reject) {
      let callUrl = '/api/cases/list/' + hospitalId  + '?limit=' + limit;
      let params = {};
      $.get(callUrl, params).then((response) => {
        resolve(response);
      });
    });
  }

  const doResubmitReport = function(caseId){
    let callUrl = '/api/uicommon/do/resubmit/' + caseId;
    let params = {};
    $.get(callUrl, params).then((response) => {
      //resolve(response);
      console.log(response);
      alert('OK');
    });
  }

  const doLoadLast20Cases = function(evt){
    let limit = $('#Limit').val();
    let hospitalId = $('#HospitalID').val();
    doCallLoadLast20Cases(hospitalId, limit).then(async (caseRes)=>{
      console.log(caseRes);
      $('#CaseList').empty();
      let caseTable = await doShowCaseList(caseRes.Records);
      $('#CaseList').append($(caseTable));
    });
  }

  const doShowCaseList = function(cases){
    return new Promise(async function(resolve, reject) {
      let caseTable = $('<table width="100%" border="1" cellpadding="0" cellspacing="0"></table>');
      let headerRow = $('<tr><td width="5%" align="center">#</td><td width="10%" align="center">Case ID</td><td width="20%" align="center">CreatedAt</td><td width="25%" align="center">Patient Name</td><td width="10%" align="center">Radio ID</td><td width="10%" align="center">Status ID</td><td width="*" align="center">CMD</td></tr>');
      $(caseTable).append($(headerRow));
      let promiseList = new Promise(async function(resolve2, reject2) {
        for (let i=0; i < cases.length; i++){
          let itemRow = $('<tr></tr>');
          $(itemRow).appendTo($(caseTable));
          $(itemRow).append($('<td align="center">' + (i+1) + '</td>'));
          $(itemRow).append($('<td align="center">' + cases[i].id + '</td>'));
          $(itemRow).append($('<td align="left">' + cases[i].createdAt + '</td>'));
          $(itemRow).append($('<td align="left">' + cases[i].patient.Patient_NameEN + ' ' + cases[i].patient.Patient_LastNameEN + '</td>'));
          let radioCol = $('<td align="center"></td>');
          let radioIdCell = $('<span data-toggle="tooltip">' + cases[i].Case_RadiologistId + '</span>');
          $(radioIdCell).on('mouseover', (evt)=>{
            doLoadRadioFullName(cases[i].Case_RadiologistId).then((callRes)=>{
              console.log(callRes.user[0]);
              let radioFN = callRes.user[0].userinfo.User_NameTH + ' ' + callRes.user[0].userinfo.User_LastNameTH;
              $(radioIdCell).prop('title', radioFN);
            });
          });
          $(itemRow).append($(radioCol));
          $(radioCol).append($(radioIdCell));
          $(itemRow).append($('<td align="center">' + cases[i].casestatusId + '</td>'));
          let cmdCol = $('<td align="center"></td>');
          $(itemRow).append($(cmdCol));
          let isEditResponse = contains.call(editResponseStatus, cases[i].casestatusId);
          if (isEditResponse){
            let reSubmitCmd = $('<input type="button" value="Re-Submit"/>');
            $(reSubmitCmd).on('click', (evt)=>{
              doResubmitReport(cases[i].id);
            });
            $(cmdCol).append($(reSubmitCmd));
          } else {
            $(cmdCol).append($('<span></span>'));
          }
        }
        setTimeout(()=> {
          resolve2($(caseTable));
        },500);
      });
      Promise.all([promiseList]).then((ob)=> {
        resolve(ob[0])
      });
    });
  }

  const editResponseStatus = [5, 6, 10, 11, 12, 14];

  const contains = function(needle) {
    // Per spec, the way to identify NaN is that it is not equal to itself
    var findNaN = needle !== needle;
    var indexOf;

    if(!findNaN && typeof Array.prototype.indexOf === 'function') {
      indexOf = Array.prototype.indexOf;
    } else {
      indexOf = function(needle) {
        var i = -1, index = -1;

        for(i = 0; i < this.length; i++) {
          var item = this[i];

          if((findNaN && item !== item) || item === needle) {
            index = i;
            break;
          }
        }

        return index;
      };
    }
    return indexOf.call(this, needle) > -1;
  }

</script>
