<!DOCTYPE html>
<html>
  <head>
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
    <title>Rad Connext</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  	<script type="text/javascript" src="../../lib/jquery.js"></script>
  	<script type="text/javascript" src="../../lib/jquery-ui.min.js"></script>
  	<script type="text/javascript" src="../../lib/jquery.loading.min.js"></script>
    <script type="text/javascript" src="../../lib/notify.min.js"></script>
    <link rel='stylesheet' href='../../lib/jquery-ui.min.css' />
    <link rel='stylesheet' href='../../stylesheets/style.css' />
  </head>
  <body>
    <div id="ShowCaseList">
      <div>
        <label for="HospitalID">Hospital:</label><span>  </span>
        <select id="HospitalID"></select><span>  </span>
        <label for="Limit">Limit:</label><span>  </span>
        <select id="Limit"></select><span>  </span>
        <input type="button" id="LoadCaseCmd" value="Load Cases."/>
      </div>
      <div id="CaseList"></div>
    </div>
  </body>
</html>
<script type="text/javascript">

  $( document ).ready(function() {
    console.log(localStorage.getItem('token'));

    $.ajaxSetup({
      beforeSend: function(xhr) {
        xhr.setRequestHeader('Authorization', localStorage.getItem('token'));
      }
    });
    let userdata = JSON.parse(localStorage.getItem('userdata'));
    console.log(userdata);

    initPage();

    $('#LoadCaseCmd').on('click', (evt)=>{
      doLoadLast20Cases(evt);
    });
  });

  const initPage = function(){
    $('#Limit').empty();
    $('#Limit').append($('<option value="10">10</option>'));
    $('#Limit').append($('<option value="20">20</option>'));
    $('#Limit').append($('<option value="30">30</option>'));
    $('#Limit').append($('<option value="40">40</option>'));
    $('#Limit').append($('<option value="50">50</option>'));
    $('#Limit').append($('<option value="100">100</option>'));
    $('#Limit').val("20").change();
    $('#HospitalID').empty();
    doCallLoadHospitalList().then((hospitals)=>{
      hospitals.Options.forEach((hospital, i) => {
        let hosItem = $('<option value="' + hospital.Value + '">' + hospital.DisplayText + '</option>');
        $(hosItem).appendTo($('#HospitalID'));
      });
    });
  }

  const doCallLoadHospitalList = function(){
    return new Promise(async function(resolve, reject) {
      let callUrl = '/api/hospital/options';
      let params = {};
      $.post(callUrl, params).then((response) => {
        resolve(response);
      });
    });
  }

  const doLoadRadioFullName = function(radioId){
    return new Promise(async function(resolve, reject) {
      let callUrl = '/api/users/select/' + radioId;
      let params = {};
      $.get(callUrl, params).then((response) => {
        resolve(response);
      });
    });
  }

  const doCallLoadLast20Cases = function(hospitalId, limit){
    return new Promise(async function(resolve, reject) {
      let callUrl = '/api/cases/list/' + hospitalId  + '?limit=' + limit;
      let params = {};
      $.get(callUrl, params).then((response) => {
        resolve(response);
      });
    });
  }

  const doResubmitReport = function(caseId){
    let callUrl = '/api/uicommon/do/resubmit/' + caseId;
    let params = {};
    $.get(callUrl, params).then((response) => {
      //resolve(response);
      console.log(response);
      alert('OK');
    });
  }

  const doReZipCase = function(caseId){
    let callUrl = '/api/cases/rezip/' + caseId;
    let params = {};
    $.get(callUrl, params).then((response) => {
      //resolve(response);
      console.log(response);
      alert('OK');
    });
  }

  function doCallLoadStudyTags(hospitalId, studyId){
    return new Promise(async function(resolve, reject) {
      let rqBody = '{"Level": "Study", "Expand": true, "Query": {"PatientName":"TEST"}}';
      let orthancUri = '/studies/' + studyId;
	  	let params = {method: 'get', uri: orthancUri, body: rqBody, hospitalId: hospitalId};
      let callLoadUrl = '/api/orthancproxy/find'
      $.post(callLoadUrl, params).then((response) => {
        resolve(response);
      });
    });
  }

  function doReStructureDicom(hospitalId, studyId, dicom){
    return new Promise(async function(resolve, reject) {
      let params = {hospitalId: hospitalId, resourceId: studyId, resourceType: "study", dicom: dicom};
      let restudyUrl = '/api/dicomtransferlog/add';
      $.post(restudyUrl, params).then((response) => {
        resolve(response);
      });
    });
  }

  function doReDicomLog(hospitalID, studyID){
    return new Promise(async function(resolve, reject) {
      let studyTags = await doCallLoadStudyTags(hospitalID, studyID);
      console.log(studyTags);
      let reStudyRes = await doReStructureDicom(hospitalID, studyID, studyTags);
      console.log(reStudyRes);
      alert('OK');
    });
  }

  const doLoadLast20Cases = function(evt){
    let limit = $('#Limit').val();
    let hospitalId = $('#HospitalID').val();
    doCallLoadLast20Cases(hospitalId, limit).then(async (caseRes)=>{
      console.log(caseRes);
      $('#CaseList').empty();
      let caseTable = await doShowCaseList(caseRes.Records);
      $('#CaseList').append($(caseTable));
    });
  }

  const doShowCaseList = function(cases){
    return new Promise(async function(resolve, reject) {
      let caseTable = $('<table width="100%" border="1" cellpadding="0" cellspacing="0"></table>');
      let headerRow = $('<tr><td width="5%" align="center">#</td><td width="10%" align="center">Case ID</td><td width="20%" align="center">Created At</td><td width="25%" align="center">Patient Name</td><td width="10%" align="center">Radio ID</td><td width="10%" align="center">Status ID</td><td width="*" align="center">CMD</td></tr>');
      $(caseTable).append($(headerRow));
      let promiseList = new Promise(async function(resolve2, reject2) {
        for (let i=0; i < cases.length; i++){
          let itemRow = $('<tr></tr>');
          $(itemRow).appendTo($(caseTable));
          $(itemRow).append($('<td align="center">' + (i+1) + '</td>'));
          $(itemRow).append($('<td align="center">' + cases[i].id + '</td>'));
          let caseCreateAt = cases[i].createdAt;

          let d = new Date(caseCreateAt);
          let casedate = formatDateStr(d);
          let casetime = formatTimeStr(d);

          $(itemRow).append($('<td align="left">' + casedate + ' : ' + casetime + '</td>'));
          $(itemRow).append($('<td align="left">' + cases[i].patient.Patient_NameEN + ' ' + cases[i].patient.Patient_LastNameEN + '</td>'));
          let radioCol = $('<td align="center"></td>');
          let radioIdCell = $('<span data-toggle="tooltip">' + cases[i].Case_RadiologistId + '</span>');
          $(radioIdCell).on('mouseover', (evt)=>{
            doLoadRadioFullName(cases[i].Case_RadiologistId).then((callRes)=>{
              console.log(callRes.user[0]);
              let radioFN = callRes.user[0].userinfo.User_NameTH + ' ' + callRes.user[0].userinfo.User_LastNameTH;
              $(radioIdCell).prop('title', radioFN);
            });
          });
          $(itemRow).append($(radioCol));
          $(radioCol).append($(radioIdCell));
          $(itemRow).append($('<td align="center">' + cases[i].casestatusId + '</td>'));
          let cmdCol = $('<td align="center"></td>');
          $(itemRow).append($(cmdCol));
          let isEditResponse = contains.call(editResponseStatus, cases[i].casestatusId);
          if (isEditResponse){
            let reSubmitCmd = $('<input type="button" value="Re-Submit"/>');
            $(reSubmitCmd).on('click', (evt)=>{
              doResubmitReport(cases[i].id);
            });
            $(cmdCol).append($(reSubmitCmd));
          } else {
            let reZipCmd = $('<input type="button" value="Re-Zip"/>');
            $(reZipCmd).on('click', (evt)=>{
              doReZipCase(cases[i].id);
            });
            $(cmdCol).append($(reZipCmd));
            $(cmdCol).append($('<span>  </span>'));
            let reDicomCmd = $('<input type="button" value="Re-Dicom"/>');
            $(reDicomCmd).on('click', (evt)=>{
              doReDicomLog(cases[i].hospitalId, cases[i].Case_OrthancStudyID);
            });
            $(cmdCol).append($(reDicomCmd));
          }
        }
        setTimeout(()=> {
          resolve2($(caseTable));
        },500);
      });
      Promise.all([promiseList]).then((ob)=> {
        resolve(ob[0])
      });
    });
  }

  const editResponseStatus = [5, 6, 10, 11, 12, 14];

  const contains = function(needle) {
    // Per spec, the way to identify NaN is that it is not equal to itself
    var findNaN = needle !== needle;
    var indexOf;

    if(!findNaN && typeof Array.prototype.indexOf === 'function') {
      indexOf = Array.prototype.indexOf;
    } else {
      indexOf = function(needle) {
        var i = -1, index = -1;

        for(i = 0; i < this.length; i++) {
          var item = this[i];

          if((findNaN && item !== item) || item === needle) {
            index = i;
            break;
          }
        }

        return index;
      };
    }
    return indexOf.call(this, needle) > -1;
  }

  const formatDateStr = function(d) {
		var yy, mm, dd;
		yy = d.getFullYear();
		if (d.getMonth() + 1 < 10) {
			mm = '0' + (d.getMonth() + 1);
		} else {
			mm = '' + (d.getMonth() + 1);
		}
		if (d.getDate() < 10) {
			dd = '0' + d.getDate();
		} else {
			dd = '' + d.getDate();
		}
		var td = `${yy}-${mm}-${dd}`;
		return td;
	}

	const formatTimeStr = function(d) {
		var hh, mn, ss;
		hh = d.getHours();
    if (hh < 10){
      hh = '0' + hh;
    }
		mn = d.getMinutes();
    if (mn < 10){
      mn = '0' + mn;
    }
		ss = d.getSeconds();
    if (ss < 10){
      ss = '0' + ss;
    }
		var td = `${hh}:${mn}:${ss}`;
		return td;
	}

</script>

<style>
  .tooltip {
  	position: relative;
  	display: inline-block;
  	border-bottom: 1px dotted black;
  }

  .tooltip .tooltiptext {
  	visibility: hidden;
  	width: 120px;
  	background-color: #555;
  	color: #fff;
  	text-align: center;
  	border-radius: 6px;
  	padding: 5px 0;
  	position: absolute;
  	z-index: 1;
  	bottom: 125%;
  	left: 50%;
  	margin-left: -60px;
  	opacity: 0;
  	transition: opacity 0.3s;
  }

  .tooltip .tooltiptext::after {
  	content: "";
  	position: absolute;
  	top: 100%;
  	left: 50%;
  	margin-left: -5px;
  	border-width: 5px;
  	border-style: solid;
  	border-color: #555 transparent transparent transparent;
  }

  .tooltip:hover .tooltiptext {
  	visibility: visible;
  	opacity: 1;
  }
</style>
